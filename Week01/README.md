学习笔记

1. 为什么选型grpc:

        restful约束比较松散;接口文档需要更新不强约束
        restful一般为http1.1,不能够复用连接,可能一个页面建立很多tcp连接；C/S架构不能双向传输
        grpc内置healthCheck，结合服务发现使用防止请求阻塞和发现不了网络问题

2. grpc的healthCheck

- 服务发现的外挂注册：

        服务向注册中心提供健康监测，监测成功才能注册
- 平滑发布(graceful shutdown):  
         
        服务提供者收到kill信号
        告诉服务注册中心注销服务
        服务提供者的healthCheck响应失败
        等待两个心跳周期内大部分的服务消费者退出
        10-60s内无法退出的kill -9强制退出

3. 服务发现

- 客户端服务发现

        服务提供者向服务中心注册
        服务消费者从服务中心拿到服务提供者的地址
        跟服务提供者直连
        缺点：需要处理服务提供者的连接；需要客户端实现负载均衡
        
- 服务端服务发现

        有一个负载中心器比如nginx，把请求转发给服务提供者
        服务提供者向服务中心注册服务，nginx从服务中心拿到服务提供者的地址(nginx upsync)
        缺点：nginx需要多个，一个扛不住。此时需要加LVS的四层负载均衡暴露一个虚ip;多了一个网络跳转
        
- 实践

        最早使用Zookeeper但是中心化的注册服务扛不住大量服务注册与注销
        后面用euerka(AP)牺牲一致性保证几秒延迟的最终一致性
        
        
4. 多集群




        同一个机房内对同一个服务部署多个集群,主库只有一个(mysql),每个集群一个缓存(redis)
        对单一节点来说，正常要使用N+2的节点方式来冗余节点
        缓存的清理：订阅mysql的binlog异步对每个集群的缓存进行更改
        问题：
            1,一个集群故障服务消费者切换集群时大量cache miss; 解决是服务消费者连接多个集群
            2,公用服务的心跳开销占据了30%; 解决是将服务均衡分配给客户端
        
        
5. 多租户 

        本质上解决rpc的路由和rpc颜色
        用来解决为服务测试的案例，在请求的header中添加测试应用的特殊标签，在路由间通过传递context寻找需要测试的特殊应用
        注意数据隔离：缓存的key或者db修改，防止新旧版本相互影响
        
推荐书籍：googleSre